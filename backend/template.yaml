AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: ë˜‘ìˆœì´ ì„œë²„ë¦¬ìŠ¤ ë°±ì—”ë“œ (Supabase + AWS Bedrock) - Python 3.11 Updated

# ============================================================
# íŒŒë¼ë¯¸í„° (ë°°í¬ ì‹œ ì„¤ì • ê°€ëŠ¥)
# ============================================================
Parameters:
  SupabaseUrl:
    Type: String
    Description: Supabase í”„ë¡œì íŠ¸ URL
    Default: https://your-project-id.supabase.co
  
  SupabaseServiceKey:
    Type: String
    NoEcho: true
    Description: Supabase ì„œë¹„ìŠ¤ ì—­í•  í‚¤
  
  BedrockModelId:
    Type: String
    Default: apac.amazon.nova-lite-v1:0
    Description: Bedrock Model ID for AI processing
  
  TitanEmbeddingModelId:
    Type: String
    Default: amazon.titan-embed-text-v2:0
    Description: Titan Embeddings V2 ëª¨ë¸ ID
  
  PublicDataPortalApiKey:
    Type: String
    NoEcho: true
    Description: ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ (ë³µì§€ë¡œ, ì¼ìë¦¬, í–‰ì •ì•ˆì „ë¶€ ë“± í†µí•©)
    Default: ""

  OpenAIApiKey:
    Type: String
    NoEcho: true
    Description: OpenAI API Key for text-embedding-3-small

  MoisApiUrl:
    Type: String
    Description: í–‰ì •ì•ˆì „ë¶€ API URL
    Default: "https://apis.data.go.kr/1741000/StanReginCd/getStanReginCdList"

# ============================================================
# ì „ì—­ ì„¤ì • (K-Wave Nowì™€ ë™ì¼í•œ AWS í™˜ê²½)
# ============================================================
Globals:
  Function:
    Timeout: 120
    MemorySize: 512
    Runtime: python3.11
    Environment:
      Variables:
        # Supabase ì„¤ì •
        SUPABASE_URL: !Ref SupabaseUrl
        SUPABASE_SERVICE_KEY: !Ref SupabaseServiceKey
        
        # AWS Bedrock ì„¤ì • (K-Wave Nowì™€ ë™ì¼)
        BEDROCK_REGION: "ap-northeast-2"
        BEDROCK_MODEL_ID: !Ref BedrockModelId
        TITAN_EMBEDDING_MODEL_ID: !Ref TitanEmbeddingModelId
        
        # Slack ì•Œë¦¼ (K-Wave Nowì™€ ë™ì¼ ì±„ë„)
        SLACK_MONITORING_WEBHOOK: "https://hooks.slack.com/services/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"
        SLACK_ERROR_WEBHOOK: "https://hooks.slack.com/services/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"
        
        # OpenAI ì„¤ì •
        OPENAI_API_KEY: !Ref OpenAIApiKey
        
        # ê³µê³µë°ì´í„°í¬í„¸ í†µí•© API í‚¤
        PUBLIC_DATA_PORTAL_API_KEY: !Ref PublicDataPortalApiKey
  
  Api:
    Cors:
      AllowMethods: "'GET,POST,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization'"
      AllowOrigin: "'*'"

# ============================================================
# ë¦¬ì†ŒìŠ¤ ì •ì˜
# ============================================================
Resources:
  # 1. ì¹´ì¹´ì˜¤ ì±—ë´‡ ì›¹í›… í•¸ë“¤ëŸ¬
  KakaoWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ttok-sun-i-kakao-webhook
      Description: ì¹´ì¹´ì˜¤í†¡ ì±—ë´‡ ë©”ì‹œì§€ ì²˜ë¦¬ ë° RAG ì‘ë‹µ (OpenAI v2026-02-01)
      CodeUri: functions/kakao_webhook/
      Handler: app.lambda_handler
      Timeout: 30
      MemorySize: 256
      AutoPublishAlias: live
      # Provisioned Concurrency (ì™„ë²½í•œ Cold Start ì œê±°)
      # ë¹„ìš©: 256MB ê¸°ì¤€ ~$6.5/ì›” (ë©”ëª¨ë¦¬ ìµœì í™”ë¡œ 50% ì ˆê°!)
      # í™œì„±í™” ë°©ë²•: ì•„ë˜ 2ì¤„ ì£¼ì„ í•´ì œ
      # ProvisionedConcurrencyConfig:
      #   ProvisionedConcurrentExecutions: 1
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource: 
              - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/${BedrockModelId}"
              - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/${TitanEmbeddingModelId}"
      Events:
        KakaoApi:
          Type: Api
          Properties:
            Path: /kakao/webhook
            Method: post

  # 2. ë°ì´í„° ìˆ˜ì§‘ ë°°ì¹˜ ì‘ì—…
  DataCollectorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ttok-sun-i-data-collector
      Description: ê³µê³µ í˜œíƒ ë°ì´í„° ìˆ˜ì§‘ (ë§¤ì¼ ì˜¤ì „ 11ì‹œ KST)
      CodeUri: functions/data_collector/
      Handler: app.lambda_handler
      Timeout: 900  # 15ë¶„
      MemorySize: 1024
      AutoPublishAlias: live
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
            Resource:
              - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/${BedrockModelId}"
              - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/${TitanEmbeddingModelId}"
          - Effect: Allow
            Action:
              - textract:DetectDocumentText
              - textract:AnalyzeDocument
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
            Resource: !Sub "${TempDocsBucket.Arn}/*"
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            # ë§¤ì¼ ì˜¤ì „ 11ì‹œ KST (UTC 02:00)
            Schedule: "cron(0 2 * * ? *)"
            Description: "ë§¤ì¼ ì˜¤ì „ 11ì‹œ KSTì— ë°ì´í„° ìˆ˜ì§‘ ì‹¤í–‰"
            Enabled: true

  # 3. Supabase í”„ë¡œì íŠ¸ í™œì„± ìƒíƒœ ìœ ì§€
  KeepAliveFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ttok-sun-i-keep-alive
      Description: Supabase í”„ë¡œì íŠ¸ í™œì„± ìƒíƒœ ìœ ì§€ (ì£¼ 1íšŒ)
      CodeUri: functions/keep_alive/
      Handler: app.lambda_handler
      Timeout: 10
      MemorySize: 128
      AutoPublishAlias: live
      Events:
        WeeklySchedule:
          Type: Schedule
          Properties:
            # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 9ì‹œ KST (UTC 00:00)
            Schedule: "cron(0 0 ? * SUN *)"
            Description: "ì£¼ 1íšŒ Supabase í™œì„±í™”"
            Enabled: true

  # 4. S3 ë²„í‚· (ì„ì‹œ ë¬¸ì„œ ì €ì¥ìš©)
  TempDocsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ttok-sun-i-temp-docs-${AWS::AccountId}'
      LifecycleConfiguration:
        Rules:
          - Id: DeleteAfter1Day
            Status: Enabled
            ExpirationInDays: 1
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # 5. í–‰ì •êµ¬ì—­ ì½”ë“œ ì—…ë°ì´íŠ¸
  RegionUpdaterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ttok-sun-i-region-updater
      Description: í–‰ì •êµ¬ì—­ ì½”ë“œ ì—…ë°ì´íŠ¸ (ë¶„ê¸°ë³„ 1íšŒ)
      CodeUri: functions/region_updater/
      Handler: app.lambda_handler
      Timeout: 900
      MemorySize: 512
      AutoPublishAlias: live
      Environment:
        Variables:
          SUPABASE_URL: !Ref SupabaseUrl
          SUPABASE_SERVICE_KEY: !Ref SupabaseServiceKey
          PUBLIC_DATA_PORTAL_API_KEY: !Ref PublicDataPortalApiKey
          MOIS_API_KEY: !Ref PublicDataPortalApiKey
          MOIS_API_URL: !Ref MoisApiUrl
          SLACK_MONITORING_WEBHOOK: "https://hooks.slack.com/services/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"
          SLACK_ERROR_WEBHOOK: "https://hooks.slack.com/services/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"
      Events:
        QuarterlySchedule:
          Type: Schedule
          Properties:
            # ë§¤ ë¶„ê¸°(1,4,7,10ì›”) 1ì¼ ì˜¤ì „ 4ì‹œ KST (ì „ì¼ 19:00 UTC)
            Schedule: cron(0 19 31 3,6,9,12 ? *)
            Enabled: true

  # 6. Lambda Warming (Cold Start ë°©ì§€) - í…ŒìŠ¤íŠ¸ ì¤‘ ë¹„í™œì„±í™” âš ï¸
  # ğŸ“‹ ì„œë¹„ìŠ¤ ì˜¤í”ˆ ì‹œ í™œì„±í™” ë°©ë²•:
  #   1. ì•„ë˜ KakaoWebhookWarmingRuleê³¼ KakaoWebhookWarmingPermissionì˜ ì£¼ì„ ì œê±°
  #   2. sam deploy --no-confirm-changeset --force-upload
  # ğŸ’° ë¹„ìš©: ~$0.05/ì›” (ê±°ì˜ ë¬´ë£Œ)
  # ğŸ¯ íš¨ê³¼: Cold Start 95%+ ì œê±°
  
  # KakaoWebhookWarmingRule:
  #   Type: AWS::Events::Rule
  #   Properties:
  #     Name: ttok-sun-i-kakao-webhook-warming
  #     Description: "1ë¶„ë§ˆë‹¤ Lambdaë¥¼ í˜¸ì¶œí•˜ì—¬ Cold Start ë°©ì§€ (ìµœì í™”)"
  #     ScheduleExpression: "rate(1 minute)"
  #     State: ENABLED
  #     Targets:
  #       - Arn: !GetAtt KakaoWebhookFunction.Arn
  #         Id: "KakaoWarmingTarget"
  #         Input: '{"warming": true}'
  # 
  # KakaoWebhookWarmingPermission:
  #   Type: AWS::Lambda::Permission
  #   Properties:
  #     FunctionName: !Ref KakaoWebhookFunction
  #     Action: lambda:InvokeFunction
  #     Principal: events.amazonaws.com
  #     SourceArn: !GetAtt KakaoWebhookWarmingRule.Arn

# ============================================================
# ì¶œë ¥ê°’
# ============================================================
Outputs:
  KakaoWebhookUrl:
    Description: ì¹´ì¹´ì˜¤ ì±—ë´‡ ì›¹í›… URL
    Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/kakao/webhook'
    Export:
      Name: !Sub '${AWS::StackName}-KakaoWebhookUrl'
  
  TempDocsBucketName:
    Description: ì„ì‹œ ë¬¸ì„œ ì €ì¥ S3 ë²„í‚·
    Value: !Ref TempDocsBucket
    Export:
      Name: !Sub '${AWS::StackName}-TempDocsBucket'
  
  DataCollectorFunctionArn:
    Description: ë°ì´í„° ìˆ˜ì§‘ Lambda ARN
    Value: !GetAtt DataCollectorFunction.Arn
